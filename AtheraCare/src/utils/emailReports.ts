import { DailyActivity, WeeklyStats, getWeeklyActivity, calculateWeeklyStats, getCurrentWeekRange } from './activityTracker';
import { getMedications } from './medications';
import { getTodayHydration } from './hydration';

export interface WeeklyHealthReport {
  userId: string;
  displayName: string;
  weekStart: string;
  weekEnd: string;
  medications: {
    totalTaken: number;
    totalMissed: number;
    completionRate: number;
    averageStreak: number;
  };
  water: {
    totalOz: number;
    averageOz: number;
    averagePercentage: number;
    goalOz: number;
  };
  steps: {
    totalSteps: number;
    averageSteps: number;
    averagePercentage: number;
    goal: number;
  };
  mood: {
    average: number;
    daysTracked: number;
  };
  energy: {
    average: number;
    daysTracked: number;
  };
  achievements: string[];
}

export const generateWeeklyHealthReport = async (
  userId: string,
  displayName: string
): Promise<WeeklyHealthReport | null> => {
  try {
    const weekRange = getCurrentWeekRange();
    const activities = await getWeeklyActivity(userId, weekRange.startDate, weekRange.endDate);
    
    if (activities.length === 0) {
      return null; // No data to report
    }

    const stats = calculateWeeklyStats(activities);
    
    // Generate achievements list
    const achievements: string[] = [];
    
    if (stats.medications.completionRate >= 90) {
      achievements.push('ðŸŽ¯ Excellent medication adherence this week!');
    }
    
    if (stats.water.averagePercentage >= 100) {
      achievements.push('ðŸ’§ Consistently met water goals!');
    }
    
    if (stats.steps.averagePercentage >= 100) {
      achievements.push('ðŸ‘Ÿ Exceeded daily step goals!');
    }
    
    if (stats.mood.average >= 4) {
      achievements.push('ðŸ˜Š Maintained positive mood throughout the week');
    }
    
    if (stats.energy.average >= 4) {
      achievements.push('âš¡ High energy levels maintained');
    }
    
    if (achievements.length === 0) {
      achievements.push('ðŸŒŸ Great job staying consistent with health tracking!');
    }

    return {
      userId,
      displayName,
      weekStart: weekRange.startDate,
      weekEnd: weekRange.endDate,
      medications: stats.medications,
      water: {
        ...stats.water,
        goalOz: activities[0]?.water.goalOz || 64
      },
      steps: {
        ...stats.steps,
        goal: activities[0]?.steps.goal || 10000
      },
      mood: stats.mood,
      energy: stats.energy,
      achievements
    };
  } catch (error) {
    console.error('Error generating weekly health report:', error);
    return null;
  }
};

export const formatWeeklyReportEmail = (report: WeeklyHealthReport): string => {
  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });
  };

  const formatPercentage = (value: number) => `${Math.round(value)}%`;
  const formatNumber = (value: number) => value.toLocaleString();

  return `
ðŸ“Š Weekly Health Report for ${report.displayName}

ðŸ“… Week of ${formatDate(report.weekStart)} - ${formatDate(report.weekEnd)}

ðŸ’Š MEDICATION ADHERENCE
â€¢ Completion Rate: ${formatPercentage(report.medications.completionRate)}
â€¢ Medications Taken: ${report.medications.totalTaken}
â€¢ Medications Missed: ${report.medications.totalMissed}
â€¢ Average Streak: ${Math.round(report.medications.averageStreak)} days

ðŸ’§ HYDRATION PROGRESS
â€¢ Average Daily Intake: ${Math.round(report.water.averageOz)} oz
â€¢ Goal Achievement: ${formatPercentage(report.water.averagePercentage)}
â€¢ Total Weekly Intake: ${formatNumber(report.water.totalOz)} oz
â€¢ Daily Goal: ${report.water.goalOz} oz

ðŸ‘Ÿ ACTIVITY & STEPS
â€¢ Average Daily Steps: ${formatNumber(Math.round(report.steps.averageSteps))}
â€¢ Goal Achievement: ${formatPercentage(report.steps.averagePercentage)}
â€¢ Total Weekly Steps: ${formatNumber(report.steps.totalSteps)}
â€¢ Daily Goal: ${formatNumber(report.steps.goal)} steps

ðŸ˜Š MOOD & ENERGY
â€¢ Average Mood: ${report.mood.average > 0 ? `${report.mood.average.toFixed(1)}/5` : 'Not tracked'}
â€¢ Average Energy: ${report.energy.average > 0 ? `${report.energy.average.toFixed(1)}/5` : 'Not tracked'}
â€¢ Days Tracked: ${report.mood.daysTracked} days

ðŸ† THIS WEEK'S ACHIEVEMENTS
${report.achievements.map(achievement => `â€¢ ${achievement}`).join('\n')}

---
This report was automatically generated by AtheraCare.
Your health data is private and secure.
  `.trim();
};

export const sendWeeklyHealthReport = async (
  familyEmail: string,
  report: WeeklyHealthReport
): Promise<boolean> => {
  try {
    // For now, we'll use a simple email service
    // In a production app, you'd integrate with a service like SendGrid, Mailgun, or AWS SES
    
    const emailContent = formatWeeklyReportEmail(report);
    const subject = `ðŸ“Š Weekly Health Report - ${report.displayName}`;
    
    // For development/testing, we'll log the email content
    console.log('=== WEEKLY HEALTH REPORT EMAIL ===');
    console.log('To:', familyEmail);
    console.log('Subject:', subject);
    console.log('Content:', emailContent);
    console.log('==================================');
    
    // TODO: Integrate with actual email service
    // Example with a hypothetical email service:
    // await emailService.send({
    //   to: familyEmail,
    //   subject: subject,
    //   html: emailContent.replace(/\n/g, '<br>'),
    //   from: 'noreply@atheracare.com'
    // });
    
    // For now, return true to simulate successful sending
    return true;
  } catch (error) {
    console.error('Error sending weekly health report:', error);
    return false;
  }
};

export const scheduleWeeklyReport = async (
  userId: string,
  displayName: string,
  familyEmail: string
): Promise<void> => {
  try {
    // Generate the report
    const report = await generateWeeklyHealthReport(userId, displayName);
    
    if (report) {
      // Send the report
      const success = await sendWeeklyHealthReport(familyEmail, report);
      
      if (success) {
        console.log('Weekly health report sent successfully to:', familyEmail);
      } else {
        console.error('Failed to send weekly health report to:', familyEmail);
      }
    } else {
      console.log('No health data available for weekly report');
    }
  } catch (error) {
    console.error('Error in weekly report scheduling:', error);
  }
};
